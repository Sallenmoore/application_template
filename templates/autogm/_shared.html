{% import "shared/_form.html" as form_components %}
{% import "shared/_display.html" as display_components %}
{% import "shared/_icons.html" as icon_components %}
{% import "shared/_tasks.html" as task_components %}
{% import "shared/_abilities.html" as abilities_components %}

{% macro gm(user, world, party=None) -%}
<title>{{world.name | title}} - Auto GM</title>
<div class="row">
    {% if party and party.last_scene and party.last_scene.prompt %}
    <div class="column" style='position:relative;'>
        <button class='button is-small' style='position:absolute; top:0; right:0;'
                onclick='this.nextElementSibling.classList.toggle("is-hidden");'>
            Debug
        </button>
        <div class="panel has-bg-muted has-text-dark is-hidden">
            <pre
                 style='overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;'>{{party.last_scene.prompt | safe }}
            </pre>
        </div>
    </div>
    {% endif %}
    {% if party.next_scene %}
    <div class="column is-shrink">
        <div class="select">
            <select name='gmmode' id='gmmode' hx-post='/api/autogm/{{party.pk}}/mode'
                    hx-target='#page-content'>
                <option>==mode==</option>
                {% for w in ['Manual', 'GM', 'PC'] %}
                <option value="{{w | lower}}" {% if party.next_scene.gm_mode==w | lower %} selected
                        {% endif %}>
                    {{w}}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>
    {% endif %}
</div>
<div id='auto-gm-container' class="row" style='position: relative;'>
    {% if not party %}
    <div id="party-selection-form-container" class="column is-full">
        <form hx-post='/api/autogm/'
              hx-target='#page-content'
              hx-trigger='change'
              onchange='history.pushState({}, "", `/faction/${this.querySelector("#partypk").value}/gm`);'>
            <div class="row has-centered">
                <div class="column is-shrink is-vertically-centered">
                    <div class="is-select">
                        <select class='has-text-center' name='partypk' id='partypk'>
                            <option>==Select Party==</option>
                            {% for p in world.parties %}
                            <option value="{{p.pk}}">
                                {{ p.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </form>
    </div>
    {% elif not party.next_scene %}
    <div id="autogm-scene-container" class="column is-full">
        {{ autogm_start_session(user, world, party) }}
    </div>
    {% endif %}
</div>
<script>
    var music = new Audio();
    music.volume = 0.25;
    var gm = new Audio();
    gm.volume = 1;

    function gmvoiced(voicefile, musicfile) {
        console.log(gm.paused, voicefile, musicfile);
        if (!gm.paused) {
            gm.pause();
            music.pause();
        } else {
            if (musicfile) {
                music.pause();
                music.src = musicfile;
                music.loop = true;
                music.volume = 0.2;
                music.currentTime = 0;
                music.play();
            }
            gm.pause();
            gm.src = voicefile;
            gm.volume = 1;
            gm.currentTime = 0;
            gm.play();
        }
    }

    function setbonus(elem) {
        console.log('click');
        let stat = elem.querySelector('p');
        modifier = parseInt(stat.textContent.split('(')[1].split(')')[0]);
        document.getElementById("pc_roll_modifier").value = (modifier >= 0) ? `+${modifier}` : `-${Math.abs(modifier)}`;
        document.getElementById("pc_roll_modifier").scrollIntoView({ behavior: "smooth", block: "center", inline: "center" });
    }


</script>
{%- endmacro %}


{% macro autogm_start_session(user, world, party) -%}
<div class="panel">
    <h3>Party</h3>
    <div id='party-members-list' class="row has-space-around">
        {% for player in party.players %}
        <div id="player-{{player.pk}}-card-container"
             class="column is-6">
            {{display_components.object_display(player, size="large", dim="250", type=False)}}
        </div>
        {% endfor %}
    </div>
    <form hx-post="/api/autogm/{{party.pk}}/start" hx-swap='outerHTML'
          hx-push-url='/{{party.path}}/gm'>
        <input type='hidden' name='partypk' value='{{party.pk}}'>
        <div class="row has-centered">
            <div class="column is-full is-vertically-centered">
                <div class="panel has-bg-muted">
                    <h4 class='has-text-primary has-text-center'>Scenario</h4>
                    <h6 class='has-text-primary has-text-center'>(optional)</h6>
                    <textarea class="has-bg-white" name='scenario'
                              style='height: 5rem; padding: 1rem;'></textarea>
                </div>
            </div>
            <div class="column is-shrink is-vertically-centered">
                <button type='submit' class="button">
                    Start Session
                </button>
            </div>
        </div>
    </form>
</div>
{%- endmacro %}


{% macro scene_overview(user, world, party)%}
<div id="scene-description-panel" class="panel has-bg-white generated-text-lightbg"
     style='position:relative; border-top-left-radius: 0;border-top-right-radius:0;'>
    <div class="row">
        {% if party.last_scene and party.last_scene.summary %}
        <div class="column is-full">
            {{scene_party_summary(user, world, party)}}
            <hr>
        </div>
        <div id="autogm-last-scene-description" class='column is-full'>
            <div class="row has-space-around">
                <div class="column">
                    <div class="panel has-bg-primary generated-text-darkbg">
                        {{party.last_scene.description | safe}}
                    </div>
                    <div class="image is-tile is-margin-center">
                        <img src="{{party.last_scene.image.url()}}"
                             loading="lazy"
                             alt="{{party.name}}" />
                    </div>
                </div>
            </div>
        </div>
        {% if party.last_scene.roll_required %}
        <div class='column is-full'>
            {{ scene_dice_results(party, party.last_scene) }}
        </div>
        {% endif %}
        {% endif %}
        <div class='column is-full'>
            {{scene_party_details(user, world, party)}}
        </div>
        <div id="scene_quest_log" class='column is-full'>
            <div class="panel has-no-padding-left has-no-padding-right ">
                <h3 class='has-text-center has-text-dark'> Quest Log </h3>
                <div class="panel has-bg-white has-text-primary" style='border-top-left-radius: 0;
            border-top-right-radius:0;'>
                    {% for quest in party.next_scene.quest_log %}
                    <div class="row has-space-between"
                         onclick='this.querySelector("#quest-{{quest.pk}}").classList.toggle("is-hidden");'>
                        <div class="column is-shrink">
                            {% if party.next_scene.current_quest == quest%}
                            <span class='tag is-muted'>
                                Current Quest
                            </span>
                            {% else %}
                            <button class='button is-small has-bg-screen'
                                    hx-post='/api/autogm/party/{{party.pk}}/quest/current/{{quest.pk}}'
                                    hx-target='#scene_quest_log'
                                    hx-select='#scene_quest_log' hx-swap='outerHTML'>
                                Set as Current Quest
                            </button>
                            {% endif %}
                        </div>
                        <div class="column is-shrink has-text-center is-vertically-centered">
                            <h3 class="has-text-primary has-text-center">
                                {{quest.name}}
                            </h3>
                            <h6 class="has-text-primary has-text-center">{{quest.status | title}}
                            </h6>
                        </div>
                        <div class="column is-shrink is-vertically-centered">
                            <button class='button is-small has-bg-dark-grey'
                                    hx-post='/api/autogm/party/{{party.pk}}/quest/delete/{{quest.pk}}'
                                    hx-target='closest .row' hx-swap='delete'>
                                Remove Quest
                            </button>
                        </div>
                        <div id="quest-{{quest.pk}}"
                             class="column is-full is-vertically-centered is-hidden">
                            <div class="row">
                                <div class="column has-text-primary">
                                    <h5 class="has-text-primary has-text-center">Objective</h5>
                                    <div class="panel has-bg-muted">
                                        {{quest.description | safe}}
                                    </div>
                                </div>
                                <div class="column">
                                    <h5 class="has-text-primary has-text-center">Importance</h5>
                                    <div class="panel has-bg-muted">{{quest.importance | safe}}
                                    </div>
                                </div>
                                <div class="column is-full">
                                    <h5 class="has-text-primary has-text-center">Next Actions</h5>
                                    <div class='panel'>
                                        <p class="has-text-white">{{quest.next_steps | safe}}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div id='autogm-associations-list-container' class='column is-full'>
            <div class="row has-space-around">
                <div class="column is-half">
                    <h4 class='has-text-center has-text-primary'>Search Associations</h4>
                    <div class="has-dropdown" style="width: 100%;">
                        <input class="has-bg-light" autocomplete="off" type="search"
                               name="query"
                               style="border-bottom: solid #000;"
                               hx-post="/api/autogm/{{party.pk}}/associations/search"
                               hx-target="#autogm-new-associations-list"
                               hx-trigger="input changed delay:500ms consume"
                               hx-on:input="this.value.length < 3 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')">
                        <ul class="dropdown has-bg-light" id="autogm-new-associations-list">
                        </ul>
                    </div>
                </div>
                <div class="column is-full">
                    <h4 class='has-text-center has-text-primary'>Create a new...</h4>
                    <div class="row has-space-around">
                        {% for child in party.all_models() %}
                        <div class="column is-shrink has-text-center">
                            <button class="button is-primary has-text-white is-small"
                                    hx-post="/api/autogm/{{party.pk}}/associations/add/{{child.__name__ | lower}}"
                                    hx-target="#page-content"
                                    hx-indicator='#request-indicator'>
                                {{party.get_title(child)}}
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="column is-full">
                    <div class="panel has-bg-screen">
                        <div id='autogm-associations-list' class="row has-space-around">
                            {% for a in party.next_scene.get_additional_associations() %}
                            <div class="column is-3 has-space-around autogm-association-entry">
                                {{display_components.object_display(a, size="small")}}
                                <div class="row has-space-around">
                                    <div class="column is-shrink"
                                         style='font-size: 0.75rem;'>
                                        <a class="has-text-primary"
                                           hx-post="/api/autogm/{{party.pk}}/scene/add/{{a.path}}"
                                           hx-target='#autogm-associations-list-container'
                                           hx-select='#autogm-associations-list-container'
                                           hx-swap='outerHTML'>
                                            {{icon_components.add(size='1.25rem')}}
                                        </a>
                                        Add to Scene
                                    </div>
                                    <div class="column is-shrink">
                                        <a hx-post="/api/autogm/{{party.pk}}/association/remove/{{a.path}}"
                                           hx-target='closest .autogm-association-entry'
                                           hx-swap='delete'>
                                            {{icon_components.remove(size='1rem')}}
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% if party.next_scene.scene_objects() %}
                <div class="column is-full">
                    <h4 class='has-text-center has-text-primary'>Scene Objects</h4>
                    <div id="autogm_scene_objects" class="row has-space-around">
                        {% for obj in party.next_scene.scene_objects() %}
                        <div id="obj-{{obj.pk}}" class='column is-4' style='position:relative;'>
                            {% if obj.image %}
                            {{display_components.object_display(obj, size="small")}}
                            {% endif %}
                            <a style="position:absolute;bottom:0;right:0;"
                               hx-post="/api/autogm/{{party.pk}}/scene/remove/{{obj.path}}"
                               hx-target='closest .column'
                               hx-swap='delete'>
                                {{icon_components.remove(size='1rem')}}
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{%- endmacro %}


{% macro scene_next_actions(user, world, party, scene)%}
{% if party.next_scene.next_actions %}
<section class="section is-small">
    {% if party.next_scene.gm_mode in ['manual', 'pc'] and not party.next_scene.gm_ready %}
    <button class='button is-small is-full'
            onclick='document.querySelector("#next-actions-container").insertAdjacentHTML("afterbegin", `<div class="column is-full"><h4 class="has-text-light-grey has-text-center">Possible Action</h4><textarea class="has-bg-muted" name="next_actions[]"></textarea></div>`);'>
        {{icon_components.text(size='3rem')}}
        Add Next Action
    </button>
    <form hx-post='/api/autogm/{{party.pk}}/update' hx-trigger='input delay:1s'
          hx-swap='none'>
        <div id="next-actions-container" class="row has-space-around">
            {% for na in party.next_scene.next_actions %}
            <div class='column is-full'>
                <h4 class='has-text-dark-grey has-text-center'>Possible Action #{{loop.index}}</h4>
                <textarea class="has-bg-muted" style="padding:1rem;"
                          name='next_actions[]'>{{na}}</textarea>
            </div>
            {% endfor %}
            {% if not party.ready %}
            <div class='column is-full'>
                <h4 class='has-text-center has-text-primary'>...Or decide your own fate</h4>
            </div>
            {% endif %}
        </div>
    </form>
    {% else %}
    <h3 class='has-text-center'>Next Actions</h3>
    <div class="row has-space-around">
        {% for na in party.last_scene.next_actions %}
        <div class='column is-full'>
            <div class="panel has-text-white">
                <h4 class='has-text-light-grey has-text-center'>Possible Action #{{loop.index}}</h4>
                {{na}}
            </div>
        </div>
        {% endfor %}
        <div class='column is-full'>
            <h4 class='has-text-center has-text-primary'>...Or decide your own fate</h4>
        </div>
    </div>
    {% endif %}
</section>
{% endif %}
{% endmacro %}


{% macro scene_description(user, world, party)%}
<div class="row has-space-around">
    {% if party.last_scene.audio %}
    <div class="column is-shrink">
        <iconify-icon icon="mdi:speaking" width="2.5rem"></iconify-icon>
        <audio id="scene-narration-player" autoplay controls>
            <source src="/audio/gm/{{party.last_scene.pk}}" type="audio/mpeg">
        </audio>
    </div>
    <div class="column is-shrink">
        <h6>Music</h6>
        <div class="is-switch">
            <input type="checkbox" id="scene-music-player-switch">
            <label for="scene-music-player-switch"></label>
        </div>
        <audio autoplay id="scene-music-player" loop>
            <source src="{{party.last_scene.music}}" type="audio/mpeg">
        </audio>
        <script>
            var narrator = document.getElementById("scene-narration-player");
            narrator.volume = 1;
            var music_player = document.getElementById('scene-music-player');
            var music_switch = document.getElementById('scene-music-player-switch');
            function playmusic() {
                console.log(music_switch.checked);
                if (music_switch.checked) {
                    music_player.volume = 0.1;
                    music_player.play();
                } else {
                    music_player.pause();
                }
            };
            music_switch.addEventListener('click', playmusic);
            playmusic();

        </script>
    </div>
    {% endif %}
    <div class="column">
        <div class="panel has-bg-primary generated-text-darkbg">
            {{party.last_scene.description | safe}}
        </div>
        <div class="image is-tile is-margin-center">
            {% if not party.last_scene.image %}
            <span id="last-scene-image-{{party.pk}}"
                  hx-trigger='load delay:3s'
                  hx-target='#last-scene-image-{{party.pk}}'
                  hx-select='#last-scene-image-{{party.pk}}'
                  hx-swap='outerHTML'></span>
            {% else %}
            <img src="{{party.last_scene.image.url()}}"
                 loading="lazy"
                 alt="{{party.name}}" />
            {% endif %}
        </div>
    </div>
</div>
{%- endmacro %}

{% macro scene_scenario_details(user, world, party) %}
<div class="section is-small">
    <form hx-post="/api/autogm/{{party.pk}}/update"
          hx-trigger='input delay:1s, from:#continue-session-button' hx-swap='none'>
        <div class="row">
            <div class="column is-full is-vertically-centered">
                <h3 class='has-text-center has-text-primary'>Scenario</h3>
                {{form_components.texteditor(user, party.next_scene, "description", content=party.next_scene.description or "")}}
            </div>
        </div>
        <div class="panel has-text-center has-bg-muted">
            <div class="row has-space-around">
                <div class="column is-shrink is-vertically-centered">
                    <label class='has-text-primary'>Scene Type</label>
                    <div class="select" style="width: 100%;">
                        <select name="scene_type" id="scene_type">
                            {% for st in [
                            "social",
                            "combat",
                            "investigation",
                            "exploration",
                            "stealth",
                            "puzzle",
                            ]
                            %}
                            <option value="{{st}}" {% if
                                    party.last_scene.type|lower==st|lower %}
                                    selected
                                    {% endif %}>
                                {{st | title}}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="column is-shrink is-vertically-centered">
                    <label class='has-text-primary' for="date">Date</label>
                    <input type="string" name="date" id="date"
                           value='{{party.next_scene.date or party.world.current_date}}'>
                </div>
                <div class="column is-full is-vertically-centered">
                    <h4 class="has-text-screen has-text-center">Roll Required</h4>
                    <div class='row has-centered'>
                        <div class="column is-shrink">
                            <div class="is-select">
                                <select name="pc_roll_player">
                                    <option value=''>== Select Player ==</option>
                                    {% for pc in party.players %}
                                    <option value='{{pc.pk}}'>{{pc.name}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="column is-shrink has-text-dark">
                            needs to make a
                        </div>
                        <div class="column is-shrink">
                            <div class="panel has-bg-muted has-text-center">
                                <div class="is-select">
                                    <select name="pc_roll_attribute">
                                        {% for attr in ['strength', 'dexterity',
                                        'constitution',
                                        'intelligence', 'wisdom', 'charisma'] %}
                                        <option value='{{attr}}'>{{attr | title}}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="column is-shrink">
                            <div class="is-select">
                                <select class="has-text-center"
                                        name="pc_roll_type">
                                    <option value='Ability Check'>Ability Check
                                    </option>
                                    <option value='Saving Throw'>Saving Throw
                                    </option>
                                    {% if party.next_scene.type == "combat" %}
                                    <option value='Attack'>Attack</option>
                                    <option value='Damage'>Damage</option>
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endmacro %}


{% macro scene_party_details(user, world, party, size="large", collapse=True) -%}
<div id="scene-party-details-container" class='row has-space-around'>
    <div class="column is-full">
        <div class="tabs has-bg-muted is-vertically-centered">
            <ul class="tabs__list has-centered has-text-primary">
                {% for player in party.players %}
                <li style='padding: 1rem;'
                    onclick='playerPanelSelect("#player-{{player.pk}}-card-container");'>
                    <a href="#scene-party-details-container"
                       class='is-small-heading has-text-center has-text-primary'>{{player.name}}</a>
                </li>
                {% if not loop.last %}
                <li>{{icon_components.d20dice(size="1rem")}}</li>
                {% endif %}
                {% endfor %}
            </ul>
            <script>
                function playerPanelSelect(target) {
                    for (var panel of document.querySelector("#player-card-panels").children) {
                        panel.classList.add("is-hidden");
                    }
                    document.querySelector(target).classList.remove("is-hidden");
                }
            </script>
        </div>
    </div>
    <div class="column is-full">
        <div id="player-card-panels" class="row has-space-around">
            {% for player in party.players %}
            <div id="player-{{player.pk}}-card-container"
                 class="column is-full {% if collapse and not loop.first %} is-hidden {% endif%}">
                {{scene_player_card(user, party, player, size)}}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{%- endmacro %}


{% macro scene_player_card(user, party, player, size='large') %}
<div id="player-card-container-{{player.pk}}" class='panel has-bg-screen'>
    <h3 class='has-text-center has-text-black'>
        {{player.name}}
    </h3>
    <div id="object-card-{{player.pk}}" class='row initiative-card'>
        <div class="column is-shrink">
            {{display_components.object_display(player, size="{{size}}", dim="250", name=False,
            type=False)}}
        </div>
        {% if size == 'large'%}
        <div class="column is-shrink">
            <div class="row">
                <div class="column is-full player-card-abilities">
                    <div class="panel has-bg-muted">
                        <div class="row has-space-around has-text-center has-text-dark"
                             style='cursor: pointer;'>
                            <div class="column is-4 is-mobile-3" onclick='setbonus(this);'>
                                <h4 class="has-text-dark">STR</h4>
                                <p>{{player.strength}} ({{(player.strength|int-10)//2}})</p>
                            </div>
                            <div class="column is-4 is-mobile-3" onclick='setbonus(this);'>
                                <h5 class="has-text-dark">DEX</h5>
                                <p>{{player.dexterity}} ({{(player.dexterity|int-10)//2}})</p>
                            </div>
                            <div class="column is-4 is-mobile-3" onclick='setbonus(this);'>
                                <h5 class="has-text-dark">INT</h5>
                                <p>{{player.intelligence}}
                                    ({{(player.intelligence|int-10)//2}})</p>
                            </div>
                            <div class="column is-4 is-mobile-3" onclick='setbonus(this);'>
                                <h5 class="has-text-dark">WIS</h5>
                                <p>{{player.wisdom}} ({{(player.wisdom|int-10)//2}})</p>
                            </div>
                            <div class="column is-4 is-mobile-3" onclick='setbonus(this);'>
                                <h5 class="has-text-dark">CHA</h5>
                                <p>{{player.charisma}} ({{(player.charisma|int-10)//2}})</p>
                            </div>
                            <div class="column is-4 is-mobile-3" onclick='setbonus(this);'>
                                <h5 class="has-text-dark">CON</h5>
                                <p>{{player.constitution}}
                                    ({{(player.constitution|int-10)//2}})</p>
                            </div>
                        </div>
                    </div>
                    <div class="row has-space-around">
                        <div class="column is-shrink">
                            <h4 class='has-text-dark has-text-center'>Current HP</h4>
                            <div class="row has-space-around">
                                <div class="column is-shrink  inputlabel">
                                    <input class="has-text-center has-text-dark"
                                           style='font-size:1.25rem; width:5rem;'
                                           name='current_hitpoints'
                                           value="{{player.current_hitpoints}}"
                                           hx-post='/api/autogm/{{player.pk}}/current_hitpoints'
                                           hx-swap='none' />
                                </div>
                                <div class="column is-shrink">
                                    <h5 class='has-text-dark'>/{{player.hitpoints}}</h5>
                                </div>
                            </div>
                        </div>
                        <div class="column is-shrink">
                            <h4 class='has-text-dark has-text-center'>AC</h4>
                            <h5 class='has-text-dark has-text-center'>{{player.ac}}</h5>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        <div class="column">
            <div class="tabs has-bg-muted">
                <ul class="tabs__list has-centered has-space-around has-text-primary">
                    {% if party.last_scene %}
                    <li
                        onclick='panelselect("#card-actions-details-panel-{{player.pk}}");'>
                        <a>Actions</a>
                    </li>
                    {% endif %}
                    <li
                        onclick='panelselect("#card-abilities-details-panel-{{player.pk}}");'>
                        <a>Abilities</a>
                    </li>
                    {% if party.last_scene.type != 'combat' %}
                    <li
                        onclick='panelselect("#card-history-details-panel-{{player.pk}}");'>
                        <a>History</a>
                    </li>
                    {% endif %}
                </ul>
                <script>
                    function panelselect(target) {
                        for (var panel of document.querySelectorAll(".card-details-panel")) {
                            panel.classList.add("is-hidden");
                        }
                        document.querySelector(target).classList.remove("is-hidden");
                    }
                </script>
            </div>
            <div class="row">
                <div id="card-actions-details-panel-{{player.pk}}"
                     class="column card-details-panel is-full generated-text-lightbg">
                    {%if party.next_scene.gm_mode == 'pc' and party.last_scene %}
                    {% set msg = party.last_scene.get_player_message(player) %}
                    <div class="panel is-full has-bg-muted has-text-dark">
                        <h4 class='has-text-dark'>Action</h4>
                        <div class="row has-space-around">
                            <div class="column is-full">
                                <audio controls>
                                    <source src="/audio/{{msg.pk}}"
                                            type="audio/mpeg">
                                </audio>
                                <span class='tag'>Feeling {{msg.emotion | safe}} and intending to
                                    {{msg.intent | safe}}:
                                </span>
                                <div>{{msg.message | safe}}</div>
                            </div>
                        </div>
                    </div>
                    {% elif party.next_scene.gm_mode in ['gm', 'manual'] and party.last_scene.type
                    !=
                    "combat" %}
                    <div class="row">
                        <div class="column">
                            <form autocomplete="off"
                                  hx-post='/api/autogm/{{party.pk}}/update'
                                  hx-target='#scene-party-details-container'
                                  hx-select='#scene-party-details-container'
                                  hx-swap='outerHTML'
                                  hx-trigger='input delay:2s, from:#continue-session-button'>
                                <input type='hidden' name='message.playerpk' value='{{player.pk}}'>
                                <div class="panel is-full has-bg-light has-text-dark">
                                    {% set msg = party.next_scene.get_player_message(player) %}
                                    <div class="row has-space-around">
                                        <div class="column is-full">
                                            <h4 class='has-text-dark'>Action</h4>
                                            {%if party.next_scene.gm_ready %}
                                            <textarea class="has-bg-white" autocomplete="false"
                                                      name="message.player_message">{{msg.message}}</textarea>
                                            {% elif party.last_scene %}
                                            <span>{{party.last_scene.get_player_message(player)}}</span>
                                            {% endif %}
                                        </div>
                                        <div class="column is-shrink">
                                            <div class="panel has-bg-muted">
                                                <label class='has-text-dark'>Emotion</label>
                                                {%if party.next_scene.gm_ready%}
                                                <div class="is-select">
                                                    <select name="message.emotion">
                                                        <option value='steady'>Steady
                                                        </option>
                                                        <option value='happy'
                                                                {% if
                                                                msg.emotion=='happy' %}
                                                                selected
                                                                {% endif %}>
                                                            Happy
                                                        </option>
                                                        <option value='playful'
                                                                {% if
                                                                msg.emotion=='playful'
                                                                %}
                                                                selected
                                                                {% endif %}>
                                                            Playful</option>
                                                        <option value='confident'
                                                                {% if
                                                                msg.emotion=='confident'
                                                                %}
                                                                selected
                                                                {% endif %}>
                                                            Confident</option>
                                                        <option value='curious'
                                                                {% if
                                                                msg.emotion=='curious'
                                                                %}
                                                                selected
                                                                {% endif %}>
                                                            Curious</option>
                                                        <option value='reluctant'
                                                                {% if
                                                                msg.emotion=='reluctant'
                                                                %}
                                                                selected
                                                                {% endif %}>
                                                            Reluctant</option>
                                                        <option value='impatient'
                                                                {% if
                                                                msg.emotion=='impatient'
                                                                %}
                                                                selected
                                                                {% endif %}>
                                                            Impatient</option>
                                                        <option value='wary'
                                                                {% if
                                                                msg.emotion=='wary' %}
                                                                selected
                                                                {% endif %}>
                                                            Wary</option>
                                                        <option value='sad'
                                                                {% if msg.emotion=='sad'
                                                                %}
                                                                selected
                                                                {% endif %}>
                                                            Sad</option>
                                                        <option value='afraid'
                                                                {% if
                                                                msg.emotion=='afraid' %}
                                                                selected
                                                                {% endif %}>
                                                            Afraid</option>
                                                        <option value='desperate'
                                                                {% if
                                                                msg.emotion=='desperate'
                                                                %}
                                                                selected
                                                                {% endif %}>
                                                            Desperate</option>
                                                        <option value='angry'
                                                                {% if
                                                                msg.emotion=='angry' %}
                                                                selected
                                                                {% endif %}>
                                                            Angry</option>
                                                    </select>
                                                </div>
                                                {% elif party.last_scene %}
                                                <span>{{msg.emotion}}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="column is-4">
                                            <div class="panel has-bg-muted">
                                                <label class='has-text-dark'>Player
                                                    Intentions</label>
                                                {%if party.ready%}
                                                <input type="text"
                                                       value='{{msg.intent}}'
                                                       name="message.intentions" {%if
                                                       party.next_scene.is_ready%} readonly {% endif
                                                       %} />
                                                {% else %}
                                                <span>{{msg.intent}}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {%if party.ready %}
                                        <div
                                             class="column is-vertically-centered is-shrink has-text-center">
                                            <h4 class='has-text-center'>Ready</h4>
                                            <div class="is-switch has-bg-muted has-text-screen">
                                                <input type="checkbox" name="message.ready"
                                                       {% if msg.ready %} checked {% endif %}
                                                       id="message-ready-{{player.pk}}">
                                                <label
                                                       for="message-ready-{{player.pk}}"></label>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endif%}
                </div>
                <div id="card-abilities-details-panel-{{player.pk}}"
                     class="column card-details-panel is-full generated-text-lightbg is-hidden">
                    {{abilities_components.abilities(user, player)}}
                </div>
                <div id="card-history-details-panel-{{player.pk}}"
                     class="column card-details-panel is-hidden is-full generated-text-lightbg has-text-justified">
                    <h2 class='has-text-dark'>History</h2>
                    <div class="panel has-bg-light-grey">
                        {{ player.history | safe }}
                    </div>
                </div>
            </div>
        </div>
        {% if player.items %}
        <div class="column is-shrink">
            <div class="panel has-bg-dark-grey">
                <div class="row">
                    {% for item in player.items %}
                    <div class="column is-4">
                        {{display_components.object_display(item, size="tiny", type=False, name=False, modal=True)}}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{%- endmacro %}


{% macro autogm_submit_session(user, world, party) -%}
<section id="next-session-container" class='section is-small'>
    <div class="row has-space-between">
        <div class="column is-full">
            {% if party.next_scene.roll_required and not party.next_scene.roll_result %}
            <h6 class='has-text-center has-text-primary'>Roll Required before advancing to next
                scene</h6>
            {% endif %}
            <button id='continue-session-button' class="button is-full" type='submit'
                    {% if party.next_scene.roll_required and not party.next_scene.roll_result %}
                    disabled
                    {% endif %}
                    hx-post="/api/autogm/{{party.pk}}/submit"
                    hx-target='#next-session-container'
                    hx-swap="delete"
                    hx-push-url='/{{party.path}}/gm'
                    {% if party.next_scene %}
                    Continue Session
                    {% endif %}
                    </button>
                <hr>
        </div>
        {% if party.autogm_summary %}
        <div class="column is-shrink is-vertically-centered">
            <button id='regenerate-session-button' class="button is-small has-bg-light-grey"
                    hx-post="/task/generate/autogm/{{party.pk}}/regenerate"
                    hx-target='#auto-gm-container'
                    hx-push-url='/{{party.path}}/gm'>
                Regenerate Session
            </button>
        </div>
        <div class="column is-shrink is-vertically-centered">
            <button class="button is-small has-bg-muted has-text-screen"
                    hx-post="/api/autogm/{{party.pk}}/canonize"
                    hx-target='#auto-gm-container'
                    hx-select='#auto-gm-container'
                    hx-swap='outerHTML'
                    hx-confirm='This will canonize events from the current session. Are you sure you want to do this?'
                    hx-push-url='/{{party.path}}/gm'>
                End Campaign
            </button>
        </div>
        {% endif %}
        <div class="column is-shrink is-vertically-centered">
            <button class="button is-small has-bg-muted has-text-screen"
                    hx-post="/api/autogm/{{party.pk}}/clear"
                    hx-target='#auto-gm-container'
                    hx-select='#auto-gm-container'
                    hx-swap='outerHTML'
                    hx-confirm='This will clear the current session. Are you sure you want to do this?'
                    hx-push-url='/{{party.path}}/gm'>
                {% if party.autogm_summary %}
                Clear Campaign
                {% else %}
                Restart Campaign
                {% endif %}
            </button>
        </div>
    </div>
</section>
{%- endmacro %}


{% macro scene_associations(user, world, party)%}
<div id='autogm-associations-list-container' class="row has-space-around">
    {% if party.next_scene.gm_mode != "manual" or not party.ready %}
    <div class="column is-half">
        <h4 class='has-text-center has-text-primary'>Search Associations</h4>
        <div class="has-dropdown" style="width: 100%;">
            <input class="has-bg-light" autocomplete="off" type="search"
                   name="query"
                   style="border-bottom: solid #000;"
                   hx-post="/api/autogm/{{party.pk}}/associations/search"
                   hx-target="#autogm-new-associations-list"
                   hx-trigger="input changed delay:500ms consume"
                   hx-on:input="this.value.length < 3 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')">
            <ul class="dropdown has-bg-light" id="autogm-new-associations-list">
            </ul>
        </div>
    </div>
    <div class="column is-full">
        <h4 class='has-text-center has-text-primary'>Create a new...</h4>
        <div class="row has-space-around">
            {% for child in party.all_models() %}
            <div class="column is-shrink has-text-center">
                <button class="button is-primary has-text-white is-small"
                        hx-post="/api/autogm/{{party.pk}}/associations/add/{{child.__name__ | lower}}"
                        hx-target="#page-content"
                        hx-indicator='#request-indicator'>
                    {{party.get_title(child)}}
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="column is-full">
        <div class="panel has-bg-screen">
            <div id='autogm-associations-list' class="row has-space-around">
                {% for a in party.next_scene.get_additional_associations() %}
                <div class="column is-3 has-space-around autogm-association-entry">
                    {{display_components.object_display(a, size="small")}}
                    <div class="row has-space-around">
                        <div class="column is-shrink"
                             style='font-size: 0.75rem;'>
                            <a class="has-text-primary"
                               hx-post="/api/autogm/{{party.pk}}/scene/add/{{a.path}}"
                               hx-target='#autogm-associations-list-container'
                               hx-select='#autogm-associations-list-container'
                               hx-swap='outerHTML'>
                                {{icon_components.add(size='1.25rem')}}
                            </a>
                            Add to Scene
                        </div>
                        <div class="column is-shrink">
                            <a hx-post="/api/autogm/{{party.pk}}/association/remove/{{a.path}}"
                               hx-target='closest .autogm-association-entry'
                               hx-swap='delete'>
                                {{icon_components.remove(size='1rem')}}
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    {% if party.next_scene.scene_objects() %}
    <div class="column is-full">
        <h4 class='has-text-center has-text-primary'>Scene Objects</h4>
        {{autogm_scene_objects(user, world, party)}}
    </div>
    {% endif %}
</div>
{%- endmacro %}


{% macro autogm_association_search(user, party, results) %}
{% for o in results %}
<li class="dropdown__link has-bg-muted">
    <a hx-post="/api/autogm/{{party.pk}}/associations/add/{{o.path}}"
       hx-target='#autogm-associations-list'
       hx-select='#autogm-associations-list' hx-swap='outerHTML'
       onclick="this.closest('.has-dropdown').classList.remove('is-active')">
        <div class="row">
            <div class="column is-shrink">
                <div class="image is-tiny is-thumbnail" style="cursor: pointer">
                    {% if o.image %}
                    <img src="{{o.image.url(size=50)}}" alt="{{o.name}}" />
                    {% endif %}
                </div>
            </div>
            <div class="column">
                {{ o.name }}
            </div>
        </div>
    </a>
</li>
{% endfor %}
{%- endmacro %}


{% macro autogm_scene_objects(user, world, party) -%}
<div id="autogm_scene_objects" class="row has-space-around">
    {% if party.next_scene.get_npcs() %}
    <div class="column is-full">
        <div class="panel has-bg-screen">
            <h4 class="has-text-center">NPCs</h4>
            <div class="row has-space-around">
                {% for npc in party.next_scene.npcs%}
                <div id="npc-{{npc.pk}}" class='column is-4' style='position:relative;'>
                    {% if npc.image %}
                    {{display_components.object_display(npc, size="small")}}
                    {% endif %}
                    <a style="position:absolute;bottom:0;right:0;"
                       hx-post="/api/autogm/{{party.pk}}/scene/remove/{{npc.path}}"
                       hx-target='closest .column'
                       hx-swap='delete'>
                        {{icon_components.remove(size='1rem')}}
                    </a>
                    {# {% else %}
                    <div hx-post="/api/autogm/{{party.pk}}"
                         hx-target='#npc-{{npc.pk}}'
                         hx-select='#npc-{{npc.pk}}'
                         hx-trigger='load delay:3s'
                         hx-swap='outerHTML'>
                    </div> #}

                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    {% if party.next_scene.combatants %}
    <div class="column is-full">
        <div class="panel has-bg-screen">
            <h4 class="has-text-center">Combatants</h4>
            <div class="row has-space-around">
                {% for cbt in party.next_scene.combatants%}
                <div id="cbt-{{cbt.pk}}" class='column is-4' style='position:relative;'>
                    {% if cbt.image %}
                    {{display_components.object_display(cbt, size="small")}}
                    <a style="position:absolute;bottom:0;right:0;"
                       hx-post="/api/autogm/{{party.pk}}/scene/remove/{{cbt.path}}"
                       hx-target='closest .column'
                       hx-swap='delete'>
                        {{icon_components.remove(size='1rem')}}
                    </a>
                    {# {% else %}
                    <div hx-post="/api/autogm/{{party.pk}}"
                         hx-target='#cbt-{{cbt.pk}}'
                         hx-select='#cbt-{{cbt.pk}}'
                         hx-trigger='load delay:3s'
                         hx-swap='outerHTML'>
                    </div> #}
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    {% if party.next_scene.places %}
    <div class="column is-full">
        <div class="panel has-bg-screen">
            <h4 class="has-text-center">Places</h4>
            <div class="row has-space-around">
                {% for plc in party.next_scene.places%}
                <div id="plc-{{plc.pk}}" class='column is-4' style='position:relative;'>
                    {% if plc.image %}
                    {{display_components.object_display(plc, size="small")}}
                    <a style="position:absolute;bottom:0;right:0;"
                       hx-post="/api/autogm/{{party.pk}}/scene/remove/{{plc.path}}"
                       hx-target='closest .column'
                       hx-swap='delete'>
                        {{icon_components.remove(size='1rem')}}
                    </a>
                    {# {% else %}
                    <div hx-post="/api/autogm/{{party.pk}}"
                         hx-target='#plc-{{plc.pk}}'
                         hx-select='#plc-{{plc.pk}}'
                         hx-trigger='load delay:3s'
                         hx-swap='outerHTML'>
                    </div> #}
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    {% if party.next_scene.vehicles %}
    <div class="column is-full">
        <div class="panel has-bg-screen">
            <h4 class="has-text-center">Vehicles</h4>
            <div class="row has-space-around">
                {% for cbt in party.next_scene.vehicles%}
                <div id="cbt-{{cbt.pk}}" class='column is-4' style='position:relative;'>
                    {% if cbt.image %}
                    {{display_components.object_display(cbt, size="small")}}
                    <a style="position:absolute;bottom:0;right:0;"
                       hx-post="/api/autogm/{{party.pk}}/scene/remove/{{cbt.path}}"
                       hx-target='closest .column'
                       hx-swap='delete'>
                        {{icon_components.remove(size='1rem')}}
                    </a>
                    {# {% else %}
                    <div hx-post="/api/autogm/{{party.pk}}"
                         hx-target='#cbt-{{cbt.pk}}'
                         hx-select='#cbt-{{cbt.pk}}'
                         hx-trigger='load delay:3s'
                         hx-swap='outerHTML'>
                    </div> #}
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    {% if party.next_scene.loot %}
    <div class="column is-full">
        <div class="panel is-full has-bg-screen">
            <h4 class="has-text-center">Loot</h4>
            <div class="row has-space-around">
                {% for loot in party.next_scene.loot %}
                <div id="loot-{{loot.pk}}" class='column is-4' style='position:relative;'>
                    {% if loot.image %}
                    {{display_components.object_display(loot, size="small")}}
                    <a style="position:absolute;bottom:0;right:0;"
                       hx-post="/api/autogm/{{party.pk}}/scene/remove/{{loot.path}}"
                       hx-target='closest .column'
                       hx-swap='delete'>
                        {{icon_components.remove(size='1rem')}}
                    </a>
                    {# {% else %}
                    <div hx-post="/api/autogm/{{party.pk}}"
                         hx-target='#loot-{{loot.pk}}'
                         hx-select='#loot-{{loot.pk}}'
                         hx-trigger='load delay:3s'
                         hx-swap='outerHTML'>
                    </div> #}
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    {% if party.next_scene.factions %}
    <div class="column is-full">
        <div class="panel has-bg-screen">
            <h4 class="has-text-center">Factions</h4>
            <div class="row">
                {% for fct in party.next_scene.factions%}
                <div id="fct-{{fct.pk}}" class='column is-4' style='position:relative;'>
                    {% if fct.image %}
                    {{display_components.object_display(fct, size="small")}}
                    <a style="position:absolute;bottom:0;right:0;"
                       hx-post="/api/autogm/{{party.pk}}/scene/remove/{{fct.path}}"
                       hx-target='closest .column'
                       hx-swap='delete'>
                        {{icon_components.remove(size='1rem')}}
                    </a>
                    {# {% else %}
                    <div hx-post="/api/autogm/{{party.pk}}"
                         hx-target='#fct-{{fct.pk}}'
                         hx-select='#fct-{{fct.pk}}'
                         hx-trigger='load delay:3s'
                         hx-swap='outerHTML'>
                    </div> #}
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{%- endmacro %}


{% macro scene_dice_results(party, scene, roll_form=False, id='')%}
{% if scene and scene.roll_required%}
<div id="roll-form-{{scene.pk}}-{{id}}" class="row has-space-around">
    <div class="column is-full">
        <h3 class='has-text-primary'>
            {% if scene.roll_player %}
            {{scene.roll_player.name}}
            {% endif %}
            {% if scene.roll_result %}
            completed a
            {% else %}
            must perform a
            {% endif %}
            {% if scene.roll_attribute %}
            {{scene.roll_attribute | title}}
            {% endif %}
            {% if scene.roll_type %}
            {{scene.roll_type | title}}
            {% endif %}
            {% if scene.roll_result %}
            , {{scene.roll_formula}},
            with a result of {{scene.roll_result}}
            {% endif %}
        </h3>
    </div>
    {% if scene.roll_description %}
    <div class="column is-full">
        <div class='panel has-text-light has-text-justified generated-text-lightbg'>
            {% if scene.roll_audio %}
            <button class="button is-small has-bg-screen"
                    onclick='gmvoiced("/audio/gm/roll/{{scene.pk}}");'>
                <iconify-icon icon="mdi:speaking" width="2.5rem"></iconify-icon>
            </button>
            {% endif %}
            {{scene.roll_description}}
        </div>
    </div>
    {% endif %}
    {% if roll_form %}
    <div class="column">
        <div class="panel has-text-center has-bg-muted">
            <h3 class="has-text-screen has-text-center">Roll Required</h3>
            <form hx-post="/api/autogm/{{party.pk}}/update"
                  hx-trigger='submit, from:#continue-session-button'
                  hx-target='#roll-form-{{scene.pk}}-{{id}}'
                  hx-select='#roll-form-{{scene.pk}}-{{id}}' hx-swap='outerHTML'>
                <div class='row has-space-around'>
                    <div class="column is-full is-vertically-centered">
                        <button class="button" type='submit'>Roll</button>
                    </div>
                    <div class="column">
                        <div class="row has-space-around">
                            <div class="column is-3 is-vertically-centered">
                                <input type="number" value="1" name="pc_roll_num_dice">
                            </div>
                            <div class="column is-2 is-vertically-centered">
                                <p class='has-text-primary'
                                   style='font-size: 1.5rem; font-weight: bold;'>
                                    D
                                </p>
                            </div>
                            <div class="column is-3 is-vertically-centered">
                                <div class="is-select">
                                    <select name="pc_roll_type_dice">
                                        <option value='4'>4</option>
                                        <option value='6'>6</option>
                                        <option value='8'>8</option>
                                        <option value='10'>10</option>
                                        <option value='12'>12</option>
                                        <option value='20' selected>20</option>
                                        <option value='100'>100</option>
                                    </select>
                                </div>
                            </div>
                            <div class="column is-3 is-vertically-centered">
                                <input type="text"
                                       value="{{party.next_scene.roll_formula | bonus }}"
                                       name="pc_roll_modifier"
                                       id="pc_roll_modifier">
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}
{%- endmacro %}


{% macro scene_quest_log(user, world, party) -%}
{% if party.next_scene.quest_log %}
<div id="scene_quest_log"
     class="panel  has-no-padding-left has-no-padding-right ">

    <h3 class='has-text-center has-text-dark'> Quest Log </h3>

    <div class="panel has-bg-white has-text-primary" style='border-top-left-radius: 0;
border-top-right-radius:0;'>

        {% for quest in party.next_scene.quest_log %}
        <div class="row has-space-between"
             onclick='this.querySelector("#quest-{{quest.pk}}").classList.toggle("is-hidden");'>
            <div class="column is-shrink">
                {% if party.next_scene.current_quest == quest%}
                <span class='tag is-muted'>
                    Current Quest
                </span>
                {% else %}
                <button class='button is-small has-bg-screen'
                        hx-post='/api/autogm/party/{{party.pk}}/quest/current/{{quest.pk}}'
                        hx-target='#scene_quest_log'
                        hx-select='#scene_quest_log' hx-swap='outerHTML'>
                    Set as Current Quest
                </button>
                {% endif %}
            </div>
            <div class="column is-shrink has-text-center is-vertically-centered">
                <h3 class="has-text-primary has-text-center">
                    {{quest.name}}
                </h3>
                <h6 class="has-text-primary has-text-center">{{quest.status | title}}</h6>
            </div>
            <div class="column is-shrink is-vertically-centered">
                <button class='button is-small has-bg-dark-grey'
                        hx-post='/api/autogm/party/{{party.pk}}/quest/delete/{{quest.pk}}'
                        hx-target='closest .row' hx-swap='delete'>
                    Remove Quest
                </button>
            </div>
            <div id="quest-{{quest.pk}}"
                 class="column is-full is-vertically-centered is-hidden">
                <div class="row">
                    <div class="column has-text-primary">
                        <h5 class="has-text-primary has-text-center">Objective</h5>
                        <div class="panel has-bg-muted">
                            {{quest.description | safe}}
                        </div>
                    </div>
                    <div class="column">
                        <h5 class="has-text-primary has-text-center">Importance</h5>
                        <div class="panel has-bg-muted">{{quest.importance | safe}}</div>
                    </div>
                    <div class="column is-full">
                        <h5 class="has-text-primary has-text-center">Next Actions</h5>
                        <div class='panel'>
                            <p class="has-text-white">{{quest.next_steps | safe}}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <hr>
        {% endfor %}
    </div>
</div>
{% endif %}
{%- endmacro %}

{% macro scene_party_summary(user, world, party, small=False) -%}
<div class="row">
    <div class="column is-full">
        <div class="panel has-bg-light">
            <div class="row">
                {%if party.last_scene and party.last_scene.summary %}
                <div class="column is-full">
                    <div class='generated-text-lightbg'>
                        {{party.last_scene.summary | safe}}
                    </div>
                </div>
                {% endif %}
                <div class="column is-full">
                    <div class="panel has-bg-white">
                        <div class="row has-space-around">
                            {% for ags in party.autogm_summary[-8:] %}
                            {% if ags.image %}
                            <div
                                 class="column is-3">
                                <div class="image">
                                    <img src="{{ags.image.url()}}"
                                         loading="lazy"
                                         alt="{{party.name}}" />
                                </div>
                            </div>
                            {% endif%}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{%- endmacro %}


{% macro scene_combat(user, world, party) -%}
<section class="section is-small">
    <h2 class='has-text-center has-text-primary'>Combat Initiative</h2>
    <div class="panel has-bg-white">
        {% if party.last_scene.current_combat_turn().description %}
        <div class='row'>
            <div class="column generated-text-lightbg" style='padding: 0.5rem;'>
                <button class="button has-text-muted"
                        onclick='gmvoiced("/audio/gm/combat/{{party.last_scene.current_combat_turn().pk}}",
            "{{party.next_scene.music}}");'>
                    <iconify-icon icon="mdi:speaking"
                                  width="2rem"></iconify-icon>
                </button>
                {{party.last_scene.current_combat_turn().description | safe}}
            </div>
            {% if party.last_scene.initiative.current_combat_turn().image %}
            <div class="column is-shrink">
                <div class="image is-extra-large">
                    <img
                         src="{{party.last_scene.initiative.current_combat_turn().image.url()}}">
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

    </div>
    <div class="panel has-no-padding has-bg-screen"
         style='z-index:100; position: sticky; top:0;'>
        <a style='z-index:101; position: absolute; top:0;'
           onclick="toggleinitdetails(this);">
            {{icon_components.dropdownarrow(size="3rem")}}
        </a>
        <script>
            function toggleinitdetails(elem) {
                document.querySelectorAll('.initiative-details').forEach((elem) => {
                    elem.classList.toggle('is-hidden');
                });
                if (elem.innerHTML.includes('up')) {
                    elem.innerHTML = `{{icon_components.dropuparrow(size='3rem')}}`;
                } else {
                    `{{icon_components.dropdownarrow(size='3rem')}}`;
                }
            }
        </script>
        <div id="player-card-panels" class="row has-space-around">
            {% for iniplayer in party.last_scene.initiative.order %}
            <div id="player-{{iniplayer.pk}}-card-container"
                 class="column is-1"
                 {% if party.last_scene.current_combat_turn()==iniplayer %}
                 style='border: solid 2px rgb(114, 17, 17);'
                 {% endif %}>
                <div class="row has-bg-primary" style='position: relative;'>
                    <div class="column is-shrink has-bg-screen"
                         style='position:absolute; top: 0; right: 0; z-index:100;'>
                        <h6 class='has-text-center'>AC: {{iniplayer.actor.ac}}</h6>
                    </div>
                    <div class="column is-shrink has-bg-screen"
                         style='position:absolute; top: 0; left: 0; z-index:100;'>
                        <h6 class='has-text-light'>
                            {{party.last_scene.initiative_index(iniplayer)}}
                        </h6>
                    </div>
                    <div class="column is-full">
                        {{display_components.object_display(iniplayer.actor, dim=250, type=False)}}
                    </div>
                    <div class="column is-full initiative-details is-hidden">
                        <div class="row has-centered">
                            <div class="column is-full">
                                <h6 class='has-text-muted has-text-center'>Status</h6>
                                <textarea hx-post="/api/autogm/{{party.pk}}/status/{{iniplayer.pk}}"
                                          hx-trigger='input delay:500ms'
                                          hx-swap='none'
                                          class="has-bg-white" name='status'
                                          style='width:100%; height: 3rem;'>{{iniplayer.status}}</textarea>
                            </div>
                            <div class="column">
                                <div class="row">
                                    <div class="column is-6 is-vertically-centered inputlabel">
                                        <h6 class='has-text-center'>HP</h6>
                                        <input class="has-text-center has-text-dark "
                                               name='current_hitpoints'
                                               style='font-size: 1.25rem;'
                                               value="{{iniplayer.hp}}"
                                               hx-post='/api/autogm/{{party.pk}}/combat/{{iniplayer.pk}}/hitpoints'
                                               hx-trigger='input delay:500ms'
                                               hx-swap='none' />
                                    </div>
                                    <div class="column is-shrink is-end is-vertically-centered">
                                        <h6 class='has-text-right'>Max</h6>
                                        <p class='has-text-dark'>
                                            / {{iniplayer.actor.hitpoints}}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <hr class='has-bg-muted'>
    {% set actor = party.last_scene.current_combat_turn().actor %}
    <div id="scene-combat-container" class="row has-space-around">
        <div class="column is-4">
            <div class="row">
                <div class="column is-full">
                    <div class="container">
                        <div class="row has-centered">
                            <div class="column">
                                <div class="panel has-bg-screen">
                                    <div class="row has-centered">
                                        <div class="column is-shrink">
                                            <h4><iconify-icon class="has-text-light"
                                                              icon="arcticons:dice-1"
                                                              width="2rem"></iconify-icon></h4>
                                        </div>
                                        <div class="column is-3 is-vertically-centered">
                                            <h5><iconify-icon icon="f7:number"
                                                              width="1rem"></iconify-icon> Dice
                                            </h5>
                                            <input class="has-bg-muted has-text-center"
                                                   type="number" id="numDice" min="1"
                                                   value="1">
                                        </div>
                                        <div class="column is-shrink is-vertically-centered">
                                            <h5>Dice Type</h5>
                                            <div class="select">
                                                <select class="has-text-center has-bg-light-grey"
                                                        id="typeDice">
                                                    <option value="20" selected>D20</option>
                                                    <option value="4">D4</option>
                                                    <option value="6">D6</option>
                                                    <option value="8">D8</option>
                                                    <option value="10">D10</option>
                                                    <option value="12">D12</option>
                                                    <option value="100">D100</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="column is-3 is-vertically-centered">
                                            <h5>Modifier</h5>
                                            <input class="has-text-center has-bg-muted"
                                                   type="text" id="bonus" maxlength="4"
                                                   value="+0">
                                        </div>
                                    </div>
                                    <div class="row has-centered">
                                        <div class="column">
                                            <button class=" button is-primary is-small is-full"
                                                    onclick="rollDice();">Roll</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <script>
                        function rollDice() {
                            const numDice = parseInt(document.getElementById('numDice').value, 10);
                            const typeDice = parseInt(document.getElementById('typeDice').value, 10);
                            var bonus = parseInt(document.getElementById('bonus').value, 10);

                            if (numDice <= 0 || typeDice <= 0) {
                                document.getElementById('dice_roll_result').textContent = 'Please enter valid inputs.';
                                return;
                            }

                            let total = 0;
                            let rolls = [];

                            for (let i = 0; i < numDice; i++) {
                                const roll = Math.floor(Math.random() * typeDice) + 1;
                                rolls.push(roll);
                                total += roll;
                            }

                            total += bonus;

                            document.getElementById('dice_roll_result').innerHTML = `<h4 class="has-text-center">Rolls: [${rolls.join(', ')}] + Bonus: ${bonus} </h4> <h1 class="has-text-center"> ${total} </h1>`;
                            document.getElementById('dice_roll_result').parentNode.classList.remove('is-hidden');
                        }
                    </script>
                </div>
                <div class="column is-full" style='position: relative;'>
                    <div
                         class="is-hidden panel has-bg-screen has-text-light-grey has-text-center"
                         style='width:50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);'>
                        <span id="dice_roll_result"></span>
                    </div>
                    {{scene_player_card(user, party, actor)}}
                </div>
            </div>
        </div>
        <div class="column is-8">
            <form id="scene-combat-update" hx-post='/api/autogm/{{party.pk}}/combat/update'
                  hx-trigger="input delay:500ms consume" hx-swap='none'>
                <div class="row has-space-around">
                    <div class="column">
                        <h4 class='has-text-dark has-text-center'>Action</h4>
                        <textarea class="has-bg-white" id="initiative-action-description"
                                  name='action-description'
                                  style='height: 5rem; padding: 1rem;'
                                  {% if not actor.is_player %} readonly {% endif %}>
                        {{party.last_scene.current_combat_turn().action.description}}
                        </textarea>
                        <div class="row has-space-around">
                            <div class="column is-2 inputlabel">
                                <h6 class='has-text-primary'>Attack Roll</h6>
                                <input class="has-text-primary"
                                       style='font-size: 1.5rem;'
                                       name='action_attack_roll'
                                       {% if not actor.is_player %} readonly
                                       {% endif %}
                                       value='{{party.last_scene.current_combat_turn().action.attack_roll}}'>
                            </div>
                            <div class="column  is-2 inputlabel">
                                <h6 class='has-text-primary'>Damage Roll</h6>
                                <input class="has-text-primary"
                                       style='font-size: 1.5rem;'
                                       name='action_dmg_roll'
                                       {% if not actor.is_player %} readonly
                                       {% endif
                                       %}
                                       value='{{party.last_scene.current_combat_turn().action.damage_roll}}'>
                            </div>
                            <div class="column  is-2 inputlabel">
                                <h6 class='has-text-primary'>Saving Throw</h6>
                                <input class="has-text-primary"
                                       style='font-size: 1.5rem;'
                                       name='action_saving_throw'
                                       {% if not actor.is_player %} readonly
                                       {% endif
                                       %}
                                       value='{{party.last_scene.current_combat_turn().action.saving_throw}}'>
                            </div>
                            <div class="column  is-2 inputlabel">
                                <h6 class='has-text-primary'>Skill Check</h6>
                                <input class="has-text-primary"
                                       style='font-size: 1.5rem;'
                                       name='action_skill_check'
                                       {% if not actor.is_player %} readonly
                                       {% endif
                                       %}
                                       value='{{party.last_scene.current_combat_turn().action.skill_check}}'>
                            </div>
                            <div class="column is-3">
                                <h6 class='has-text-primary'>Target</h6>
                                <div class='select'>
                                    <select name='action_target'
                                            {% if not actor.is_player %}
                                            disabled {% endif
                                            %}>
                                        {% for target in party.last_scene.initiative.order
                                        %}
                                        <option value='{{target.pk}}' {%if
                                                target.actor and
                                                party.last_scene.current_combat_turn().action.target
                                                and
                                                party.last_scene.current_combat_turn().action.target==target.actor
                                                %} selected {% endif %}>
                                            {{target.actor.name}}
                                            [{{party.last_scene.initiative_index(target)}}]
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <hr>
                        {% if actor.is_player %}
                        <div class="panel has-bg-muted">
                            <h6 class='has-text-primary has-text-center'>Available Abilities
                            </h6>
                            <div class="row has-space-around">
                                {% for ability in actor.abilities %}
                                {% if not ability.action or"main" in ability.action %}
                                <div class="column is-shrink">
                                    <h6 class="has-text-dark"
                                        onclick='this.nextElementSibling.classList.add("is-active");'>
                                        {{ability.name}}
                                    </h6>
                                    <div class="modal is-small"
                                         onclick='event.preventDefault(); this.classList.remove("is-active");'>
                                        <div class="modal__background"></div>
                                        <div class="modal__content">
                                            <button class="button is-full"
                                                    onclick="setactionability('{{ability.name}}');">
                                                Use
                                            </button>
                                            <h3 class='has-text-dark'>{{ability.name}}</h3>
                                            {{ability.description | safe}}
                                            <div class="row">
                                                <div class="column">
                                                    <div class="panel is-full has-text-white">
                                                        <h4>Effects</h4>
                                                        {{ability.effects | safe}}
                                                    </div>
                                                </div>
                                                <div class="column">
                                                    <div class="panel is-full has-text-light">
                                                        <h4>Duration</h4>
                                                        {{ability.duration | safe}}
                                                    </div>
                                                </div>
                                                <div class="column">
                                                    <div class="panel is-full has-text-muted">
                                                        <h4>Roll Requirements</h4>
                                                        {{ability.dice_roll | safe}}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                                <script>
                                    function setactionability(name) {
                                        document.querySelector('#initiative-action-description').value = `Uses ${name}`;
                                    }
                                </script>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="column">
                        <h4 class='has-text-dark has-text-center'>Bonus Action</h4>
                        <textarea id="initiative-bonus-action-description" class="has-bg-white"
                                  name='bonus_action'
                                  style='height: 5rem;padding: 1rem;'
                                  {% if not actor.is_player %} readonly {%
                                  endif
                                  %}>{{party.last_scene.current_combat_turn().bonus_action.description}}</textarea>
                        <div class="row ">
                            <div class="column is-2 inputlabel">
                                <h6 class='has-text-primary'>Attack Roll</h6>
                                <input class="has-text-primary"
                                       style='font-size: 1.5rem;'
                                       name='bonus_action_attack_roll'
                                       {% if not actor.is_player %} readonly
                                       {% endif
                                       %}
                                       value='{{party.last_scene.current_combat_turn().bonus_action.attack_roll}}'>
                            </div>
                            <div class="column is-2 inputlabel">
                                <h6 class='has-text-primary'>Damage Roll</h6>
                                <input class="has-text-primary"
                                       style='font-size: 1.5rem;'
                                       name='bonus_action_dmg_roll'
                                       {% if not actor.is_player %} readonly
                                       {% endif
                                       %}
                                       value='{{party.last_scene.current_combat_turn().bonus_action.damage_roll}}'>
                            </div>
                            <div class="column is-2 inputlabel">
                                <h6 class='has-text-primary'>Saving Throw</h6>
                                <input class="has-text-primary"
                                       style='font-size: 1.5rem;'
                                       name='bonus_action_saving_throw'
                                       {% if not actor.is_player %} readonly
                                       {% endif
                                       %}
                                       value='{{party.last_scene.current_combat_turn().bonus_action.saving_throw}}'>
                            </div>
                            <div class="column is-2 inputlabel">
                                <h6 class='has-text-primary'>Skill Check</h6>
                                <input class="has-text-primary"
                                       style='font-size: 1.5rem;'
                                       name='bonus_action_skill_check'
                                       {% if not actor.is_player %} readonly
                                       {% endif
                                       %}
                                       value='{{party.last_scene.current_combat_turn().bonus_action.saving_throw}}'>
                            </div>
                            <div class="column is-3">
                                <h6 class='has-text-primary'>Target</h6>
                                <div class='select'>
                                    <select name='bonus_action_target'
                                            {% if not actor.is_player %}
                                            disabled {% endif
                                            %}>
                                        {% for target in party.last_scene.initiative.order
                                        %}
                                        <option value='{{target.pk}}' {%if
                                                target.actor and
                                                party.last_scene.current_combat_turn().bonus_action.target
                                                and
                                                party.last_scene.current_combat_turn().bonus_action.target==target.actor
                                                %} selected {% endif %}>
                                            {{target.actor.name}}
                                            [{{party.last_scene.initiative_index(target)}}]
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        {% if actor.is_player %}
                        <hr>
                        <div class="panel has-bg-muted">
                            <h6 class='has-text-primary has-text-center'>Available Abilities
                            </h6>
                            <div class="row has-space-around">
                                {% for ability in actor.abilities %}
                                {% if not ability.action or"bonus" in ability.action %}
                                <div class="column is-shrink">
                                    <h6 class="has-text-dark"
                                        onclick='this.nextElementSibling.classList.add("is-active");'>
                                        {{ability.name}}
                                    </h6>
                                    <div class="modal is-small"
                                         onclick='event.preventDefault(); this.classList.remove("is-active");'>
                                        <div class="modal__background"></div>
                                        <div class="modal__content">
                                            <button class="button is-full"
                                                    onclick="setbonusactionability('{{ability.name}}')">
                                                Use
                                            </button>
                                            <h3 class='has-text-dark'>{{ability.name}}</h3>
                                            {{ability.description | safe}}
                                            <div class="row">
                                                <div class="column">
                                                    <div class="panel is-full has-text-white">
                                                        <h4>Effects</h4>
                                                        {{ability.effects | safe}}
                                                    </div>
                                                </div>
                                                <div class="column">
                                                    <div class="panel is-full has-text-light">
                                                        <h4>Duration</h4>
                                                        {{ability.duration | safe}}
                                                    </div>
                                                </div>
                                                <div class="column">
                                                    <div class="panel is-full has-text-muted">
                                                        <h4>Roll Requirements</h4>
                                                        {{ability.dice_roll | safe}}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                                <script>
                                    function setbonusactionability(name) {
                                        document.querySelector('#initiative-bonus-action-description').innerHTML = `Uses ${name}`;
                                    }
                                </script>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="column is-full">
                        <h4 class='has-text-dark has-text-center'>Movement</h4>
                        <textarea class="has-bg-white" name='movement'
                                  style='height: 5rem;padding: 1rem;'
                                  {% if not actor.is_player %} readonly {%
                                  endif
                                  %}>{{party.last_scene.current_combat_turn().movement}}</textarea>
                    </div>
                </div>
            </form>
        </div>
        {% if not party.last_scene.current_combat_turn().ready %}
        <div class="column is-4">
            <button class="button is-full has-bg-muted has-text-dark"
                    hx-post='/task/generate/autogm/{{party.pk}}/combat'
                    hx-target='closest .column'>
                Run Turn
            </button>
        </div>
        {% else %}
        <div class="column is-3">
            <button class='button is-full has-bg-screen'
                    hx-post='/task/generate/autogm/{{party.pk}}/combat/next'
                    hx-target='closest .column'
                    hx-confirm='This will end your turn. Are you sure?'>
                {% if party.last_scene.initiative.combat_ended %} End Combat {% else %} Next
                Turn {%
                endif %}
            </button>
        </div>
        {% endif %}
    </div>
</section>
{%- endmacro %}